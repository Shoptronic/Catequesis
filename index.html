<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Catequesis</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --azul-primario: #3b82f6;
            --azul-oscuro: #1e40af;
            --azul-claro: #eff6ff;
            --verde-exito: #10b981;
            --rojo-alerta: #ef4444;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --gris-texto: #1e293b;
            --gris-suave: #64748b;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --gris-texto: #f1f5f9;
            --azul-claro: #334155;
            --gris-suave: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--gris-texto); padding-bottom: 100px; font-size: 16px; transition: 0.3s; overflow-x: hidden; }

        header { background: linear-gradient(135deg, var(--azul-oscuro), var(--azul-primario)); color: white; padding: 30px 20px 40px; border-radius: 0 0 30px 30px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .back-btn { position: absolute; left: 20px; top: 30px; background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; display: none; font-size: 1.4rem; cursor: pointer; z-index: 101; }

        .view { display: none; padding: 20px 0; animation: fadeIn 0.2s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--bg-card); margin: 0 16px 16px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); position: relative; }
        .section-label { padding: 0 20px 12px; font-weight: 600; color: var(--gris-suave); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

        .item-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--azul-primario); }
        input:checked + .slider:before { transform: translateX(24px); }

        .search-container { padding: 0 16px 15px; margin-top: 5px; position: relative; z-index: 10; }
        .search-input { width: 100%; padding: 14px 20px; border-radius: 15px; border: 1px solid #e2e8f0; background: var(--bg-card); color: var(--gris-texto); font-size: 0.95rem; outline: none; }

        .status-btn { padding: 12px 18px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; }
        .btn-presente { background: #dcfce7; color: #166534; }
        .btn-presente.active { background: var(--verde-exito); color: white; }
        .btn-ausente { background: #fee2e2; color: #991b1b; }
        .btn-ausente.active { background: var(--rojo-alerta); color: white; }

        .pago-pill { display: inline-flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 14px; font-size: 0.8rem; font-weight: 600; margin: 4px; cursor: pointer; background: var(--azul-claro); color: var(--azul-primario); min-width: 85px; }
        .pago-pill.active { background: var(--verde-exito); color: white; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: var(--bg-card); display: flex; padding: 10px 0 25px; border-top: 1px solid #e2e8f0; z-index: 1000; }
        .tab-item { flex: 1; text-align: center; color: var(--gris-suave); font-size: 0.75rem; cursor: pointer; }
        .tab-item.active { color: var(--azul-primario); font-weight: 600; }
        .tab-icon { font-size: 1.7rem; display: block; }

        /* BOTONES FLOTANTES CORREGIDOS */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--azul-primario); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 2rem; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer; }

        .btn-main { background: var(--azul-primario); color: white; border: none; padding: 18px; width: 100%; border-radius: 18px; font-weight: 600; font-size: 1.1rem; margin-top: 15px; cursor: pointer; }
        
        .comm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-comm { border: none; padding: 15px; border-radius: 15px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 25px; padding: 30px; text-align: center; }
    </style>
</head>
<body>

    <header>
        <button class="back-btn" id="btnBack" onclick="goBack()">‚Üê</button>
        <h1>Mi Catequesis</h1>
        <p id="fecha-header">Cargando...</p>
    </header>

    <button id="fab-alumno" class="fab" onclick="prepararNuevoAlumno()">+</button>
    <button id="fab-evento" class="fab" onclick="prepararNuevaClase()">+</button>

    <div id="inicio" class="view active">
        <div class="stats-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:20px 16px 10px;">
            <div class="card" style="margin:0; text-align:center"><h3 id="count-alumnos">0</h3><p style="font-size:0.7rem">ALUMNOS</p></div>
            <div class="card" style="margin:0; text-align:center"><h3 id="count-faltas" style="color:var(--rojo-alerta)">0</h3><p style="font-size:0.7rem">FALTAS HOY</p></div>
        </div>
        <div id="home-clase-hoy" style="padding: 0 16px;"></div>
        <div class="section-label">Asistencia de Hoy</div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="üîç Buscar alumno..." onkeyup="filtrarAlumnos(this.value)">
        </div>
        <div id="lista-asistencia"></div>
    </div>

    <div id="calendario" class="view">
        <div class="section-label">Pr√≥ximas Sesiones</div>
        <div id="lista-horario"></div>
    </div>

    <div id="alumnos" class="view">
        <div class="section-label">Directorio</div>
        <div id="lista-fichas"></div>
    </div>

    <div id="pagos" class="view">
        <div class="section-label">Cobros</div>
        <div id="lista-pagos"></div>
    </div>

    <div id="ajustes" class="view">
        <div class="section-label">Preferencias</div>
        <div class="card item-row">
            <span>Modo Oscuro</span>
            <label class="switch"><input type="checkbox" id="darkModeToggle" onclick="document.body.classList.toggle('dark-mode')"><span class="slider"></span></label>
        </div>
        <div class="section-label">Conceptos <button onclick="addConcepto()" style="float:right; background:var(--azul-primario); color:white; border:none; width:25px; height:25px; border-radius:50%">+</button></div>
        <div id="lista-conceptos"></div>
        <div class="section-label">Seguridad</div>
        <div class="card">
            <button class="btn-main" onclick="exportarDatos()" style="background: var(--verde-exito);">üíæ Guardar Copia</button>
            <button class="btn-main" onclick="document.getElementById('importInput').click()" style="background: var(--azul-oscuro);">üì• Restaurar Copia</button>
            <input type="file" id="importInput" style="display:none" accept=".json" onchange="importarDatos(event)">
        </div>
    </div>

    <div id="ficha-detalle" class="view">
        <div class="card">
            <label>Nombre</label><input type="text" id="f-nombre" onchange="updateAlumno()">
            <label>Tutor</label><input type="text" id="f-tutor" onchange="updateAlumno()">
            <label>Tel√©fono</label><input type="tel" id="f-tel" onchange="updateAlumno()">
            <div class="comm-grid"><button id="f-wa" class="btn-comm" style="background:#25d366">üì± WhatsApp</button><button id="f-call" class="btn-comm" style="background:var(--azul-primario)">üìû Llamar</button></div>
            <div class="section-label" style="padding:20px 0 10px">Desglose de Pagos</div>
            <div id="f-desglose-pagos"></div>
            <label>Notas</label><textarea id="f-notas" onchange="updateAlumno()"></textarea>
            <button class="btn-main" style="background:none; color:var(--rojo-alerta); border:1px solid var(--rojo-alerta)" onclick="eliminarAlumno()">Eliminar Alumno</button>
        </div>
    </div>

    <div id="nuevo-alumno" class="view">
        <div class="card">
            <h3>Nuevo Alumno</h3>
            <label>Nombre</label><input type="text" id="newN">
            <label>Tutor</label><input type="text" id="newT">
            <label>Tel√©fono</label><input type="tel" id="newTel">
            <button class="btn-main" onclick="saveAlumno()">Guardar</button>
        </div>
    </div>

    <div id="nuevo-horario" class="view">
        <div class="card">
            <h3>Nueva Sesi√≥n</h3>
            <label>Fecha</label><input type="date" id="newHFecha">
            <label>Tema</label><input type="text" id="newHTitulo">
            <button class="btn-main" onclick="saveHorario()">Guardar</button>
        </div>
    </div>

    <div id="modalFalta" class="modal">
        <div class="modal-content">
            <h3>Motivo de la falta</h3>
            <div id="botones-motivo"></div>
            <button class="btn-main" style="background:none; color:grey" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="changeTab(this, 'inicio')"><span class="tab-icon">üè†</span>Hoy</div>
        <div class="tab-item" onclick="changeTab(this, 'calendario')"><span class="tab-icon">üìÖ</span>Horario</div>
        <div class="tab-item" onclick="changeTab(this, 'alumnos')"><span class="tab-icon">üë•</span>Lista</div>
        <div class="tab-item" onclick="changeTab(this, 'pagos')"><span class="tab-icon">üí∞</span>Pagos</div>
        <div class="tab-item" onclick="changeTab(this, 'ajustes')"><span class="tab-icon">‚öôÔ∏è</span>Ajustes</div>
    </nav>

    <script>
        const HOY_ISO = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-header').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        
        let filtroActual = "", alumnoActualId = null, vistaAnterior = 'inicio';
        const KEY_AL = 'cate_alumnos_v1', KEY_HO = 'cate_horario_v1', KEY_CO = 'cate_conceptos_v1';

        let alumnos = JSON.parse(localStorage.getItem(KEY_AL)) || [];
        let horario = JSON.parse(localStorage.getItem(KEY_HO)) || [];
        let conceptos = JSON.parse(localStorage.getItem(KEY_CO)) || [{nombre:"Cuota", precio:"15"}];

        function renderApp() {
            localStorage.setItem(KEY_AL, JSON.stringify(alumnos));
            localStorage.setItem(KEY_HO, JSON.stringify(horario));
            localStorage.setItem(KEY_CO, JSON.stringify(conceptos));

            // Home Asistencia
            const listAsis = document.getElementById('lista-asistencia');
            listAsis.innerHTML = alumnos.filter(a => a.nombre.toLowerCase().includes(filtroActual.toLowerCase())).map(a => {
                const tieneFalta = a.faltas?.some(f => f.fecha === HOY_ISO), tieneAsis = a.asistencias?.includes(HOY_ISO);
                return `<div class="card item-row"><div style="flex:1" onclick="verFicha(${a.id})"><h4>${a.nombre}</h4></div><div style="display:flex; gap:8px"><button class="status-btn btn-presente ${tieneAsis?'active':''}" onclick="marcarAsistencia(${a.id})">S√ç</button><button class="status-btn btn-ausente ${tieneFalta?'active':''}" onclick="abrirModalFalta(${a.id})">NO</button></div></div>`;
            }).join('');

            // Lista Alumnos
            document.getElementById('lista-fichas').innerHTML = alumnos.map(a => `<div class="card item-row" onclick="verFicha(${a.id})"><div><h4>${a.nombre}</h4></div><span>‚úèÔ∏è</span></div>`).join('');

            // Pagos
            document.getElementById('lista-pagos').innerHTML = alumnos.map(a => {
                let pgs = conceptos.map(c => `<div class="pago-pill ${(a.pagos && a.pagos[c.nombre])?'active':''}" onclick="togglePago(${a.id}, '${c.nombre}')">${c.nombre}<br>${c.precio}‚Ç¨</div>`).join('');
                return `<div class="card"><h4>${a.nombre}</h4><div style="margin-top:10px">${pgs}</div></div>`;
            }).join('');

            // Horario
            document.getElementById('lista-horario').innerHTML = horario.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)).map(h => `<div class="card item-row"><div><strong>${h.fecha}</strong><br>${h.titulo}</div><button onclick="deleteEvent(${h.id})" style="border:none; background:none; color:red">‚úï</button></div>`).join('');

            document.getElementById('count-alumnos').innerText = alumnos.length;
            document.getElementById('count-faltas').innerText = alumnos.filter(a => a.faltas?.some(f => f.fecha === HOY_ISO)).length;
        }

        function changeTab(el, id) {
            if(!['nuevo-horario', 'nuevo-alumno', 'ficha-detalle'].includes(id)) vistaAnterior = id;
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Gestionar botones flotantes
            document.getElementById('fab-alumno').style.display = (id === 'alumnos') ? 'flex' : 'none';
            document.getElementById('fab-evento').style.display = (id === 'calendario') ? 'flex' : 'none';
            document.getElementById('btnBack').style.display = (['ficha-detalle', 'nuevo-alumno', 'nuevo-horario'].includes(id)) ? 'block' : 'none';
        }

        function verFicha(id) {
            alumnoActualId = id; const a = alumnos.find(x => x.id === id);
            document.getElementById('f-nombre').value = a.nombre;
            document.getElementById('f-tutor').value = a.tutor || ""; 
            document.getElementById('f-tel').value = a.tel || "";
            document.getElementById('f-notas').value = a.notas || "";
            document.getElementById('f-wa').onclick = () => window.open(`https://wa.me/${a.tel}`);
            document.getElementById('f-call').onclick = () => window.open(`tel:${a.tel}`);
            
            const desglose = document.getElementById('f-desglose-pagos');
            desglose.innerHTML = conceptos.map(c => {
                const pagado = a.pagos && a.pagos[c.nombre];
                return `<div style="display:flex; justify-content:space-between; padding:12px; border-radius:15px; margin-bottom:8px; background:${pagado ? '#dcfce7' : '#fee2e2'}; border:1px solid ${pagado ? '#10b981' : '#ef4444'}"><span>${c.nombre}</span><strong>${pagado?'PAGADO':'PENDIENTE'}</strong></div>`;
            }).join('');
            changeTab(null, 'ficha-detalle');
        }

        function prepararNuevoAlumno() { changeTab(null, 'nuevo-alumno'); }
        function saveAlumno() { 
            const n = document.getElementById('newN').value;
            if(n) { 
                alumnos.push({id:Date.now(), nombre:n, tutor:document.getElementById('newT').value, tel:document.getElementById('newTel').value, asistencias:[], faltas:[], pagos:{}, notas:""}); 
                renderApp(); goBack(); 
            } 
        }

        function prepararNuevaClase() { changeTab(null, 'nuevo-horario'); }
        function saveHorario() { 
            const f = document.getElementById('newHFecha').value, t = document.getElementById('newHTitulo').value;
            if(f && t) { horario.push({id:Date.now(), fecha:f, titulo:t}); renderApp(); goBack(); }
        }

        function marcarAsistencia(id) { 
            const a = alumnos.find(x => x.id === id); 
            if(!a.asistencias) a.asistencias = [];
            if(!a.asistencias.includes(HOY_ISO)) a.asistencias.push(HOY_ISO); 
            a.faltas = a.faltas?.filter(f => f.fecha !== HOY_ISO) || []; 
            renderApp(); 
        }
        function abrirModalFalta(id) { 
            alumnoActualId = id; 
            const m = ['Enfermedad', 'M√©dico', 'Viaje', 'Otros']; 
            document.getElementById('botones-motivo').innerHTML = m.map(x => `<button class="btn-main" onclick="confirmarFalta('${x}')">${x}</button>`).join(''); 
            document.getElementById('modalFalta').style.display = 'flex'; 
        }
        function confirmarFalta(motivo) { 
            const a = alumnos.find(x => x.id === alumnoActualId); 
            if(!a.faltas) a.faltas = [];
            a.faltas = a.faltas.filter(f => f.fecha !== HOY_ISO);
            a.faltas.push({fecha: HOY_ISO, motivo: motivo}); 
            a.asistencias = a.asistencias?.filter(f => f !== HOY_ISO) || []; 
            cerrarModal(); renderApp(); 
        }
        function cerrarModal() { document.getElementById('modalFalta').style.display = 'none'; }
        function goBack() { changeTab(null, vistaAnterior); }
        function togglePago(id, conc) { 
            const a = alumnos.find(x => x.id === id); 
            if(!a.pagos) a.pagos = {};
            a.pagos[conc] = !a.pagos[conc]; 
            renderApp(); 
        }
        function updateAlumno() { 
            const a = alumnos.find(x => x.id === alumnoActualId); 
            a.nombre = document.getElementById('f-nombre').value; 
            a.tutor = document.getElementById('f-tutor').value; 
            a.tel = document.getElementById('f-tel').value; 
            a.notas = document.getElementById('f-notas').value; 
            renderApp(); 
        }
        function eliminarAlumno() { if(confirm("¬øEliminar?")) { alumnos = alumnos.filter(x => x.id !== alumnoActualId); renderApp(); goBack(); } }
        function addConcepto() { let n = prompt("Nombre:"), p = prompt("Precio:"); if(n && p) { conceptos.push({nombre:n, precio:p}); renderApp(); } }
        function deleteEvent(id) { if(confirm("¬øBorrar?")) { horario = horario.filter(h => h.id !== id); renderApp(); } }
        function filtrarAlumnos(v) { filtroActual = v; renderApp(); }
        function exportarDatos() { 
            const blob = new Blob([JSON.stringify({alumnos, horario, conceptos})], { type: "application/json" });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `Catequesis_Backup.json`; a.click();
        }
        function importarDatos(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { const d = JSON.parse(ev.target.result); alumnos=d.alumnos; horario=d.horario; conceptos=d.conceptos; renderApp(); };
            reader.readAsText(e.target.files[0]);
        }

        renderApp();

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
            });
        }
    </script>
</body>
</html>
